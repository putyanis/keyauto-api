openapi: 3.0.0
info:
  title: MA - KeyAuto API
  version: 0.0.1

tags:
  - name: Авторизация
  - name: Звонки
  - name: Задачи
  - name: Справочники

paths:
  /login:
    post:
      description: Аутентификация и авторизация
      tags:
        - Авторизация
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/authRequest'
      responses:
        '200':
          description: Если авторизация успешна
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/authResult'
        '401':
          description: Любая ошибка авторизации - неправильный логин/пароль, нет прав, пользователь не существует
  /checkToken:
    post:
      description: Проверка валидности токена
      tags:
        - Авторизация
      security:
        - tokenized: []
      responses:
        '200':
          description: Токен валидный и активный
        '401':
          description: Токен невалидный
  /call/in:
    get:
      description: Входящие звонки
      tags:
        - Звонки
      security:
        - tokenized: []
      parameters:
        - $ref: '#/components/parameters/callSort'
        - $ref: '#/components/parameters/fullText'
        - $ref: '#/components/parameters/datePreset'
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
        - $ref: '#/components/parameters/canal'
        - $ref: '#/components/parameters/contract'
        - $ref: '#/components/parameters/dealer'
        - $ref: '#/components/parameters/seller'
        - $ref: '#/components/parameters/phone'
        - $ref: '#/components/parameters/callDate'
        - $ref: '#/components/parameters/callDirection'
        - $ref: '#/components/parameters/callStatus'
        - $ref: '#/components/parameters/source'
        - $ref: '#/components/parameters/callType'
        - $ref: '#/components/parameters/callReason'
        - $ref: '#/components/parameters/callResult'
        - $ref: '#/components/parameters/callOperator'
        - $ref: '#/components/parameters/callAssignee'
      responses:
        '200':
          description: Список входящих звонков
          content:
            application/json:
              schema:
                type: object
                properties:
                  paging:
                    $ref: '#/components/schemas/paging'
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/callList'
                  statistic:
                    $ref: '#/components/schemas/callStatistic'
  /call/in/{callID}:
    put:
      description: Обновление входящего звонка
      tags:
        - Звонки
      security:
        - tokenized: [ ]
      parameters:
        - $ref: '#/components/parameters/callID'
      requestBody:
        required: true
        description: Поля входящего звонка
        content:
          'application/json':
            schema:
              allOf:
                - $ref: '#/components/schemas/callCardInUpdate'
      responses:
        '200':
          description: Результат обновления входящего звонка
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/success'
                  - $ref: '#/components/schemas/failed'
  /call/out:
    get:
      description: Исходящие звонки
      tags:
        - Звонки
      security:
        - tokenized: []
      parameters:
        - $ref: '#/components/parameters/callSort'
        - $ref: '#/components/parameters/fullText'
        - $ref: '#/components/parameters/datePreset'
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
        - $ref: '#/components/parameters/canal'
        - $ref: '#/components/parameters/contract'
        - $ref: '#/components/parameters/dealer'
        - $ref: '#/components/parameters/seller'
        - $ref: '#/components/parameters/phone'
        - $ref: '#/components/parameters/callDate'
        - $ref: '#/components/parameters/callDirection'
        - $ref: '#/components/parameters/callStatus'
        - $ref: '#/components/parameters/source'
        - $ref: '#/components/parameters/callType'
        - $ref: '#/components/parameters/callReason'
        - $ref: '#/components/parameters/callResult'
        - $ref: '#/components/parameters/callOperator'
        - $ref: '#/components/parameters/callAssignee'
      responses:
        '200':
          description: Список исходящих звонков
          content:
            application/json:
              schema:
                type: object
                properties:
                  paging:
                    $ref: '#/components/schemas/paging'
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/callList'
                  statistic:
                    $ref: '#/components/schemas/callStatistic'
    post:
      description: Регистрация исходящего звонка
      tags:
        - Звонки
      security:
        - tokenized: []
      responses:
        '200':
          description: Результат регистрации
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/success'
                  - $ref: '#/components/schemas/failed'
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/newCall'
                - $ref: '#/components/schemas/newCallExtended'
  /call/out/{callID}:
    put:
      description: Обновление исходящего звонка
      tags:
        - Звонки
      security:
        - tokenized: [ ]
      parameters:
        - $ref: '#/components/parameters/callID'
      requestBody:
        required: true
        description: Поля исходящего звонка
        content:
          'application/json':
            schema:
              allOf:
                - $ref: '#/components/schemas/callCardOutUpdate'
      responses:
        '200':
          description: Результат обновления исходящего звонка
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/success'
                  - $ref: '#/components/schemas/failed'
  /call/{callID}:
    get:
      description: Информация о звонке
      tags:
        - Звонки
      security:
        - tokenized: []
      parameters:
        - $ref: '#/components/parameters/callID'
      responses:
        '200':
          description: Полная информация о звонке
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/callCardOut'
                  - $ref: '#/components/schemas/callCardIn'
  /issue:
    get:
      description: Список задач
      tags:
        - Задачи
      security:
        - tokenized: []
      parameters:
        - $ref: '#/components/parameters/issueSort'
        - $ref: '#/components/parameters/fullText'
        - $ref: '#/components/parameters/datePreset'
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/pageSize'
        - $ref: '#/components/parameters/createdAt'
        - $ref: '#/components/parameters/doneAt'
        - $ref: '#/components/parameters/issueType'
        - $ref: '#/components/parameters/issueStatus'
        - $ref: '#/components/parameters/canal'
        - $ref: '#/components/parameters/contract'
        - $ref: '#/components/parameters/dealer'
        - $ref: '#/components/parameters/issueAssignee'
        - $ref: '#/components/parameters/seller'
        - $ref: '#/components/parameters/phone'
        - $ref: '#/components/parameters/vin'
      responses:
        '200':
          description: Список доступных задач
          content:
            application/json:
              schema:
                type: object
                properties:
                  paging:
                    $ref: '#/components/schemas/paging'
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/issueList'
                  statistic:
                    $ref: '#/components/schemas/issueStatistic'
  /dictionary/dealer:
    get:
      description: Значения справочника "Автосалон"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/dealer'
  /dictionary/operator:
    get:
      description: Значения справочника "Оператор"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/operator'
  /dictionary/seller:
    get:
      description: Значения справочника "Продавец"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/seller'
  /dictionary/issueAssignee:
    get:
      description: Значения справочника "Ответственный". Отдаем тех, пользователей, на которых текущий пользователь может назначать сущность
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/issueAssignee'
  /dictionary/canal:
    get:
      description: Значения справочника "Канал"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/canal'
  /dictionary/contract:
    get:
      description: Значения справочника "Контракт"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/contract'
  /dictionary/brand:
    get:
      description: Значения справочника "Марка автомобиля"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/brand'
  /dictionary/brand/{brandID}/model:
    get:
      description: Значения справочника "Модель автомобиля"
      tags:
        - Справочники
      security:
        - tokenized: []
      parameters:
        - in: path
          name: brandID
          description: Идентификатор марки
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/model'
  /dictionary/source:
    get:
      description: Значения справочника "Источник"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/source'
  /dictionary/reason:
    get:
      description: Значения справочника "Причина звонка"
      tags:
        - Справочники
      security:
        - tokenized: []
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/reason'
  /dictionary/need:
    get:
      description: Значения справочника "Потребность"
      tags:
        - Справочники
      security:
        - tokenized: [ ]
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/need'
  /dictionary/result:
    get:
      description: Значения справочника "Результат коммуникации"
      tags:
        - Справочники
      security:
        - tokenized: [ ]
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/callResult'
  /dictionary/callType:
    get:
      description: Значения справочника "Тип звонка"
      tags:
        - Справочники
      security:
        - tokenized: [ ]
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/callType'
  /dictionary/callAssignees:
    get:
      description: Список пользователей для фильтра "Ответственный" в звонках
      tags:
        - Справочники
      security:
        - tokenized: [ ]
      responses:
        '200':
          description: Массив значений
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/callAssignee'

components:
  securitySchemes:
    tokenized:
      in: header
      type: apiKey
      name: Authorization
  schemas:
    user:
      properties:
        id:
          type: integer
          description: ID пользователя
        name:
          type: string
          description: Имя пользователя
        lastName:
          type: string
          description: Фамилия пользователя
        role:
          type: string
          description: Роль пользователя (оценщик, старший оценщик, мастер, руководитель отдела продаж)
          enum:
            - appraiser
            - appraiserLead
            - master
            - salesHead
    authRequest:
      properties:
        login:
          type: string
          description: Логин
        password:
          type: string
          description: Пароль
    authResult:
      properties:
        token:
          type: string
          description: Токен
        user:
          $ref: '#/components/schemas/user'
    callList:
      properties:
        id:
          type: string
          description: Идентификатор звонка
        status:
          type: string
          description: Статус звонка (Принят, Нет ответа, Занято)
          enum:
            - finished
            - noAnswer
            - busy
        time:
          type: string
          format: date-time
          description: Время звонка
        contact:
          $ref: '#/components/schemas/contact'
        need:
          $ref: '#/components/schemas/need'
    callCardIn:
      properties:
        status:
          type: string
          description: Статус звонка (Принят, Нет ответа, Занято)
          enum:
            - finished
            - noAnswer
            - busy
        brand:
          $ref: '#/components/schemas/brand'
        model:
          $ref: '#/components/schemas/model'
        comment:
          type: string
          description: Комментарий
        callType:
          $ref: '#/components/schemas/callType'
        reason:
          $ref: '#/components/schemas/reason'
        result:
          $ref: '#/components/schemas/callResult'
        dealer:
          $ref: '#/components/schemas/dealer'
        operator:
          $ref: '#/components/schemas/operator'
        canal:
          $ref: '#/components/schemas/canal'
        contract:
          $ref: '#/components/schemas/contract'
        lastModified:
          type: string
          format: date-time
          description: Последнее изменение
        modifiedBy:
          type: string
          description: Изменил
        duration:
          type: integer
          description: Длительность
        record:
          type: string
          description: Ссылка на файл с записью звонка
    callCardInUpdate:
      properties:
        contact:
          $ref: '#/components/schemas/contact'
        need:
          $ref: '#/components/schemas/need'
        brand:
          $ref: '#/components/schemas/brand'
        model:
          $ref: '#/components/schemas/model'
        comment:
          type: string
          description: Комментарий
        dealer:
          $ref: '#/components/schemas/dealer'
        operator:
          $ref: '#/components/schemas/operator'
        contract:
          $ref: '#/components/schemas/contract'
    callCardOutUpdate:
      properties:
        contact:
          $ref: '#/components/schemas/contact'
        need:
          $ref: '#/components/schemas/need'
        brand:
          $ref: '#/components/schemas/brand'
        model:
          $ref: '#/components/schemas/model'
        comment:
          type: string
          description: Комментарий
        reason:
          $ref: '#/components/schemas/reason'
        result:
          $ref: '#/components/schemas/callResult'
        dealer:
          $ref: '#/components/schemas/dealer'
        contract:
          $ref: '#/components/schemas/contract'
    callCardOut:
      allOf:
        - $ref: '#/components/schemas/callCardIn'
      properties:
        source:
          $ref: '#/components/schemas/source'
        seller:
          $ref: '#/components/schemas/seller'
        assignee:
          $ref: '#/components/schemas/callAssignee'
    newCall:
      description: Новый звонок
      properties:
        status:
          type: string
          description: Статус звонка (Принят, Нет ответа, Занято)
          enum:
            - finished
            - noAnswer
            - busy
        time:
          type: string
          format: date-time
          description: Время звонка
        contact:
          $ref: '#/components/schemas/contact'
        need:
          $ref: '#/components/schemas/need'
        comment:
          type: string
          description: Комментарий
        reason:
          type: string
          description: Идентификатор из справочника "Причина звонка"
        result:
          type: string
          description: Идентификатор из справочника "Результат коммуникации"
        dealer:
          type: string
          description: Идентификатор из справочника "Автосалон"
        canal:
          type: string
          description: Идентификатор из справочника "Канал"
        contract:
          type: string
          description: Идентификатор из справочника "Контракт"
    newCallExtended:
      allOf:
        - $ref: '#/components/schemas/newCall'
      properties:
        brand:
          $ref: '#/components/schemas/brand'
        model:
          $ref: '#/components/schemas/model'
        operator:
          $ref: '#/components/schemas/operator'
        callType:
          $ref: '#/components/schemas/callType'
    issueList:
      description: Задача в списке
      properties:
        id:
          description: Идентификатор задачи
          type: string
        created:
          description: Дата создания задачи
          type: string
          format: date-time
        comment:
          description: Последний комментарий
          type: string
        type:
          $ref: '#/components/schemas/issueType'
        status:
          description: Статус задачи (Новая, В работе, Завершено)
          type: string
          enum:
            - todo
            - progress
            - done

    contact:
      description: Информация о клиенте
      properties:
        phone:
          type: string
          description: Номер телефона
        name:
          type: string
          description: Кем представился
    dictionary:
      description: Значение справочника
      properties:
        value:
          type: string
          description: Выводимое значение
        id:
          type: string
          description: Идентификатор
    dealer:
      description: Автосалон
      allOf:
        - $ref: '#/components/schemas/dictionary'
    operator:
      description: Оператор
      allOf:
        - $ref: '#/components/schemas/dictionary'
    seller:
      description: Продавец
      allOf:
        - $ref: '#/components/schemas/dictionary'
    issueAssignee:
      description: Ответственный
      allOf:
        - $ref: '#/components/schemas/dictionary'
    canal:
      description: Канал
      allOf:
        - $ref: '#/components/schemas/dictionary'
    contract:
      description: Контракт
      allOf:
        - $ref: '#/components/schemas/dictionary'
    brand:
      description: Марка автомобиля
      allOf:
        - $ref: '#/components/schemas/dictionary'
    model:
      description: Модель автомобиля
      allOf:
        - $ref: '#/components/schemas/dictionary'
    source:
      description: Источник
      allOf:
        - $ref: '#/components/schemas/dictionary'
    reason:
      description: Причина звонка
      allOf:
        - $ref: '#/components/schemas/dictionary'
    callResult:
      description: Результат коммуникации
      allOf:
        - $ref: '#/components/schemas/dictionary'
    issueType:
      description: Типы задач
      allOf:
        - $ref: '#/components/schemas/dictionary'
    need:
      description: Потребность (Обмен на автомобиль с пробегом, Обмен на новый автомобиль, Выкуп)
      allOf:
        - $ref: '#/components/schemas/dictionary'
    callType:
      description: Тип звонка (Уникальный, Целевой, Уникально-целевой, Повторный, Обратный, Прямой, Спам)
      allOf:
        - $ref: '#/components/schemas/dictionary'
    callAssignee:
      description: Ответственный за звонок
      allOf:
        - $ref: '#/components/schemas/dictionary'
    paging:
      description: Постраничная навигация
      properties:
        current:
          type: integer
          description: Текущая страница
        pages:
          type: integer
          description: Количество страниц
    success:
      description: Успешное сохранение
      properties:
        status:
          type: boolean
          description: всегда true
        id:
          type: string
          description: Идентификатор новой записи
    failed:
      description: Ошибка при сохранении
      properties:
        status:
          type: boolean
          description: всегда false
        message:
          type: string
          description: Текст ошибки
    issueStatistic:
      description: Статистика задач
      properties:
        all:
          description: Всего по фильтру
          type: integer
        progress:
          description: В работе по фильтру
          type: integer
        done:
          description: Завершено по фильтру
          type: integer
    callStatistic:
      description: Статистика звонков
      properties:
        total:
          description: Общее количество звонков по фильтру
          type: integer
  parameters:
    fullText:
      in: query
      name: fullText
      description: Полнотекстовый поиск
      required: false
      schema:
        type: string
    datePreset:
      in: query
      name: datePreset
      description: Пресет периода (Все/all, Вчера/1ago, Сегодня/ [по умолчанию], Неделя/week, Месяц/month)
      required: false
      schema:
        type: string
    pageSize:
      in: query
      name: pageSize
      description: Размер страницы
      required: false
      schema:
        type: integer
    page:
      in: query
      name: page
      description: Номер страницы
      required: false
      schema:
        type: integer
    callSort:
      in: query
      name: sort
      description: Сортировка звонков (сначала новые, сначала старые, сначала продолжительные, сначала короткие)
      required: false
      schema:
        type: string
        enum:
          - created-desc
          - created-asc
          - duration-desc
          - duration-asc
    issueSort:
      in: query
      name: sort
      description: Сортировка задач (актуальные по дате выполнения, новые по дате создания, старые по дате создания, новые по статусу, в работе по статусу, завершенные по статусу)
      required: false
      schema:
        type: string
        enum:
          - done-asc
          - created-desc
          - created-asc
          - status-from-new
          - status-from-progress
          - status-from-done
    createdAt:
      in: query
      name: created
      description: Дата создания
      required: false
      schema:
        type: string
        format: date-time
    doneAt:
      in: query
      name: done
      description: Дата выполнения
      required: false
      schema:
        type: string
        format: date-time
    issueType:
      in: query
      name: type
      description: Тип задачи (идентификатор из справочника типов задач)
      required: false
      schema:
        type: string
    issueStatus:
      in: query
      name: status
      description: Фильтра по статусам задач (Всe, В работе, Завершено
      required: false
      schema:
        type: string
    canal:
      in: query
      name: canal
      description: Фильтр по каналу (идентификатор из справочника каналов)
      required: false
      schema:
        type: string
    contract:
      in: query
      name: contract
      description: Фильтр по контракту (идентификатор из справочника контрактов)
      required: false
      schema:
        type: string
    dealer:
      in: query
      name: dealer
      description: Фильтр по автосалону (идентификатор из справочника автосалонов)
      required: false
      schema:
        type: string
    issueAssignee:
      in: query
      name: assignee
      description: Фильтр по ответственному (идентификатор из справочника пользователей, null если отмечен "Нет ответственного")
      required: false
      schema:
        type: string
    seller:
      in: query
      name: seller
      description: Фильтр по продавцу (идентификатор из справочника продавцов)
      required: false
      schema:
        type: string
    phone:
      in: query
      name: phone
      description: Номер телефона контакта/котрагента
      required: false
      schema:
        type: string
    vin:
      in: query
      name: vin
      description: VIN автомобиля
      required: false
      schema:
        type: string
    callDate:
      in: query
      name: date
      description: Дата звонка
      required: false
      schema:
        type: string
        pattern: DD.MM.YYYY
    callDirection:
      in: query
      name: direction
      description: Направление звонка (входящий, исходящий)
      required: false
      schema:
        type: string
        enum:
          - in
          - out
    callStatus:
      in: query
      name: status
      description: Статус звонка
      required: false
      schema:
        type: string
    source:
      in: query
      name: source
      description: Источник
      required: false
      schema:
        type: string
    callType:
      in: query
      name: type
      description: Тип звонка
      required: false
      schema:
        type: string
    callReason:
      in: query
      name: reason
      description: Причина звонка
      required: false
      schema:
        type: string
    callResult:
      in: query
      name: result
      description: Результат коммуникации
      required: false
      schema:
        type: string
    callOperator:
      in: query
      name: operator
      description: Оператор
      required: false
      schema:
        type: string
    callAssignee:
      in: query
      name: assignee
      description: Ответственный (null если отмечен "Нет ответственного")
      required: false
      schema:
        type: string
    callID:
      in: path
      name: callID
      description: Идентификатор звонка
      required: true
      schema:
        type: string